{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <h2>üõí Cart Checkout</h2>

  <table class="table table-bordered mt-3">
    <thead class="table-dark">
      <tr>
        <th>Book</th>
        <th>Quantity</th>
        <th>Price (‚Çπ)</th>
      </tr>
    </thead>
    <tbody>
      {% for item in cart_items %}
      <tr>
        <td>{{ item.book.title }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.book.price|floatformat:2 }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h4>Total Amount: ‚Çπ{{ total|floatformat:2 }}</h4>
  <hr>

  {% if profile.address %}
  <h5>Shipping Address:</h5>
  <p>
    {{ profile.address }}<br>
    {{ profile.city }}, {{ profile.postal_code }}
  </p>
  {% else %}
  <p class="text-danger">
    No shipping address found. <a href="{% url 'profile' %}">Update Profile</a>
  </p>
  {% endif %}

  <!-- PayPal button container -->
  <div id="paypal-button-container" class="mt-4"></div>
</div>

<!-- Load PayPal SDK once -->
<script src="https://www.paypal.com/sdk/js?client-id=AaDbFCTAdi8NU4o-x6oOaBiLLoybkvO8w3xVZ2LgPAiTRwT4dDJu5u_ZecP9OtLTDvr7GZtZk_HuM3kq&currency=USD"></script>

<script>
  // Helper to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
        }
      });
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
  const total = "{{ total|floatformat:2 }}";

  console.log("üí∞ Cart total is", total);

  paypal.Buttons({
    createOrder(data, actions) {
      console.log("üîÑ createOrder called");
      return actions.order.create({
        purchase_units: [{
          amount: { value: total }
        }]
      });
    },
    onApprove(data, actions) {
      console.log("‚úÖ onApprove called with data:", data);
      return actions.order.capture().then(details => {
        console.log("üì¶ Payment captured:", details);

        // Use Django's URL tag so it always matches your URLconf
        const url = "{% url 'cart_payment_complete' %}";
        console.log("üöÄ Calling backend at", url);

        return fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
            paymentID: details.id,
            cart: true
          })
        })
        .then(res => {
          console.log("üì® Response from backend:", res);
          return res.json();
        })
        .then(json => {
          console.log("üîî Backend JSON:", json);
          alert('Transaction completed by ' + details.payer.name.given_name + '!');
          // Redirect to your confirmation or orders page
          window.location.href = "{% url 'user_orders' %}";
        })
        .catch(err => {
          console.error("‚ùå Error calling cart_payment_complete:", err);
          alert("Something went wrong processing your order.");
        });
      });
    },
    onError(err) {
      console.error("‚ö†Ô∏è PayPal error:", err);
      alert("Payment could not be completed.");
    }
  }).render('#paypal-button-container');
</script>
{% endblock %}
